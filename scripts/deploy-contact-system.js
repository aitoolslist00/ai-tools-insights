#!/usr/bin/env node

/**
 * Automated Deployment Script for Contact System
 * Handles Vercel environment variables and deployment
 */

const fs = require('fs');
const { execSync } = require('child_process');

console.log('\nüöÄ AI Tools Insights - Contact System Deployment');
console.log('==================================================\n');

// Check if .env.production exists
if (!fs.existsSync('.env.production')) {
  console.log('‚ùå ERROR: .env.production not found');
  console.log('Please run: node scripts/setup-gmail.js first\n');
  return;
}

console.log('üìã Reading production environment variables...');
const prodEnv = fs.readFileSync('.env.production', 'utf8');
console.log('‚úÖ Production variables loaded\n');

console.log('üîß Setting up Vercel environment variables...');
console.log('(You may be prompted to login to Vercel)\n');

try {
  // Set Vercel environment variables
  const envVars = {
    'SMTP_USER': 'insightsaitools@gmail.com',
    'SMTP_HOST': 'smtp.gmail.com', 
    'SMTP_PORT': '587',
    'SMTP_SECURE': 'false',
    'NEXT_PUBLIC_BASE_URL': 'https://www.aitoolsinsights.com',
    'NEXT_PUBLIC_CONTACT_EMAIL': 'insightsaitools@gmail.com',
    'NEXTAUTH_SECRET': 'ai-tools-insights-contact-system-2024'
  };

  // Get SMTP_PASS from .env.production
  const smtpPassMatch = prodEnv.match(/SMTP_PASS=(.+)/);
  if (smtpPassMatch) {
    envVars['SMTP_PASS'] = smtpPassMatch[1];
  }

  console.log('‚öôÔ∏è Configuring Vercel environment variables...');
  
  for (const [key, value] of Object.entries(envVars)) {
    try {
      execSync(`vercel env add ${key} production`, { 
        input: value + '\n',
        stdio: ['pipe', 'pipe', 'pipe']
      });
      console.log(`‚úÖ ${key}: Configured`);
    } catch (error) {
      // Variable might already exist
      console.log(`‚ö†Ô∏è  ${key}: Already exists or failed to set`);
    }
  }

  console.log('\nüì¶ Building project...');
  execSync('npm run build', { stdio: 'inherit' });
  console.log('‚úÖ Build successful\n');

  console.log('üöÄ Deploying to Vercel...');
  execSync('vercel --prod', { stdio: 'inherit' });

  console.log('\nüéâ DEPLOYMENT COMPLETE!');
  console.log('========================');
  console.log('‚úÖ Environment variables configured');
  console.log('‚úÖ Project built successfully');
  console.log('‚úÖ Deployed to production');
  console.log('‚úÖ Contact system operational');
  
  console.log('\nüìß Your contact form is now live and will send emails to:');
  console.log('   ‚Üí insightsaitools@gmail.com');
  console.log('\nüì§ Users will receive automatic confirmation emails');
  console.log('üåê Visit your live site to test the contact form!');

} catch (error) {
  console.log('\n‚ùå DEPLOYMENT FAILED');
  console.log('====================');
  console.error('Error:', error.message);
  
  console.log('\nüîß Manual Deployment Steps:');
  console.log('1. Login to Vercel Dashboard');
  console.log('2. Go to your project ‚Üí Settings ‚Üí Environment Variables');
  console.log('3. Add variables from .env.production file');
  console.log('4. Run: vercel --prod');
}